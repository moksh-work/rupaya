# AWS Infrastructure Destruction Configuration
# 
# This file contains configuration for the destruction tool that handles
# various AWS resources and edge cases.

# AWS Configuration
AWS_REGIONS=("us-east-1" "us-west-2" "eu-west-1")
DEFAULT_REGION="us-east-1"

# Terraform Paths
TERRAFORM_PATHS=(
    "infra/aws"
    "deployment/terraform"
)

# ECR Configuration
# Repositories to cleanup (all repos will be cleaned by default)
ECR_CLEANUP_ENABLED=true
ECR_BATCH_DELETE_ENABLED=true

# RDS Configuration
# Snapshot backups before deletion (disabled for destruction)
RDS_SNAPSHOT_BEFORE_DELETE=false
RDS_SKIP_FINAL_SNAPSHOT=true

# Backup Configuration
# Create backup of Terraform state before destruction
BACKUP_STATE_FILES=true
BACKUP_DIR="./terraform-state-backups"
BACKUP_RETENTION_DAYS=30

# Resource Groups to Destroy (in order)
# Note: Order matters - dependencies should be destroyed first
RESOURCE_DESTRUCTION_ORDER=(
    "ecs_services"      # ECS services before clusters
    "elb"               # Load balancers
    "autoscaling"       # Auto scaling groups
    "ec2_instances"     # EC2 instances
    "rds_databases"     # RDS databases
    "elasticache"       # ElastiCache clusters
    "ecr_repositories"  # ECR repositories
    "s3_buckets"        # S3 buckets
    "iam_roles"         # IAM roles and policies
    "vpc"               # VPC and networking
)

# Services to wait for during destruction (seconds timeout)
SERVICE_CLEANUP_TIMEOUTS=(
    ["rds"]=600
    ["elasticache"]=300
    ["ecs"]=120
    ["ec2"]=300
    ["elb"]=180
    ["ecr"]=60
)

# Terraform Common Issues and Fixes
# These are known issues that occur during destruction
declare -A TERRAFORM_FIXES=(
    ["aws_s3_bucket_reference"]="s3_terraform_state_bucket"
    ["aws_dynamodb_reference"]="dynamodb_terraform_lock_table"
    ["ecr_non_empty"]="force_delete=true"
)

# Logging Configuration
LOG_RETENTION_DAYS=7
LOG_COMPRESSION_ENABLED=true
VERBOSE_LOGGING=false

# Safety Configuration
REQUIRE_CONFIRMATION=true
CONFIRMATION_TEXT="destroy all infrastructure"
DRY_RUN_ENABLED=false  # Shows what would be destroyed without actually destroying

# Notification Configuration
SLACK_NOTIFICATIONS=false
SLACK_WEBHOOK_URL="${SLACK_WEBHOOK_URL:-}"
EMAIL_NOTIFICATIONS=false
EMAIL_RECIPIENTS=()

# Performance Configuration
PARALLEL_DESTROY=false  # Whether to destroy multiple resources in parallel
MAX_PARALLEL_JOBS=1
TERRAFORM_PARALLELISM=10  # -parallelism flag for terraform destroy

# Pre-Destruction Validation Checks
PRE_DESTROY_CHECKS=(
    "aws_credentials"
    "terraform_installed"
    "aws_cli_installed"
    "terraform_files_exist"
    "terraform_state_valid"
    "aws_permissions"
)

# Post-Destruction Verification
POST_DESTROY_VERIFICATION_ENABLED=true
VERIFY_RESOURCE_DELETION_TIMEOUT=300  # seconds to wait for AWS resources to fully delete

# Cleanup Configuration
CLEANUP_TERRAFORM_CACHE=true     # Remove .terraform directories
CLEANUP_STATE_FILES=false         # Keep state files for reference
CLEANUP_LOCK_FILES=true          # Remove .terraform.lock.hcl

# Tagging Strategy for Protection
# Resources with these tags will be skipped (for safety)
PROTECTED_RESOURCE_TAGS=(
    "Environment=production"
    "Protected=true"
    "NoAutoDestroy=true"
)

# Exception Handling
STOP_ON_ERROR=true               # Stop on first error during destruction
CONTINUE_ON_ECR_ERROR=true       # Continue even if ECR cleanup fails
CONTINUE_ON_RDS_ERROR=false      # Stop if RDS deletion fails (data protection)

# AWS Service Endpoints (for air-gapped environments)
# AWS_ENDPOINT_OVERRIDE=""

# STS Configuration (for cross-account destruction)
# ASSUME_ROLE_ARN=""
# EXTERNAL_ID=""

# Terraform Variables Override
# Can be used to override variables during destruction if needed
# TF_VAR_overrides="-var=\"key=value\""

# Debug Configuration
DEBUG_MODE=false
DEBUG_PRINT_COMMANDS=false
SAVE_TERRAFORM_PLAN=true
PLAN_OUTPUT_FILE="destroy-plan.tfplan"
