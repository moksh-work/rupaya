name: Terraform Staged Deploy

on:
  workflow_dispatch:
    inputs:
      auto_apply:
        description: "Auto-apply changes (true/false)"
        required: true
        default: "true"

concurrency:
  group: terraform-staged-deploy
  cancel-in-progress: false

env:
  TF_IN_AUTOMATION: "true"
  AWS_REGION: "us-east-1"
  TFSTATE_BUCKET: "rupaya-terraform-state-767397779454"
  TFSTATE_DYNAMODB_TABLE: "rupaya-terraform-state-lock"
  TFSTATE_KEY: "prod/infrastructure/terraform.tfstate"

jobs:
  certificates:
    name: Stage 1 - Certificates
    runs-on: ubuntu-latest
    environment: certificates
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::767397779454:role/rupaya-terraform-cicd
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify remote state backend
        run: |
          aws s3api head-bucket --bucket "${{ env.TFSTATE_BUCKET }}"
          aws dynamodb describe-table --table-name "${{ env.TFSTATE_DYNAMODB_TABLE }}" --region "${{ env.AWS_REGION }}"

      - name: Terraform Init
        working-directory: infra/aws
        run: terraform init

      - name: Terraform Validate
        working-directory: infra/aws
        run: terraform validate

      - name: Terraform Apply (Certificates)
        if: ${{ inputs.auto_apply == 'true' }}
        working-directory: infra/aws
        run: terraform apply -auto-approve -target=module.certificates

      - name: Wait for Certificate Issuance
        if: ${{ inputs.auto_apply == 'true' }}
        working-directory: infra/aws
        run: |
          CERT_ARN=$(terraform output -raw certificate_production_arn)
          echo "Waiting for certificate: $CERT_ARN"
          for i in {1..30}; do
            STATUS=$(aws acm describe-certificate --certificate-arn "$CERT_ARN" --region "$AWS_REGION" --query 'Certificate.Status' --output text)
            echo "Status: $STATUS"
            if [ "$STATUS" = "ISSUED" ]; then
              echo "Certificate is ISSUED"
              exit 0
            fi
            sleep 60
          done
          echo "Certificate did not reach ISSUED within 30 minutes"
          exit 1

  infrastructure:
    name: Stage 2 - Infrastructure
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
      id-token: write
    needs: certificates
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::767397779454:role/rupaya-terraform-cicd
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify remote state backend
        run: |
          aws s3api head-bucket --bucket "${{ env.TFSTATE_BUCKET }}"
          aws dynamodb describe-table --table-name "${{ env.TFSTATE_DYNAMODB_TABLE }}" --region "${{ env.AWS_REGION }}"

      - name: Terraform Init
        working-directory: infra/aws
        run: terraform init

      - name: Terraform Plan
        working-directory: infra/aws
        run: terraform plan

      - name: Terraform Apply (All)
        if: ${{ inputs.auto_apply == 'true' }}
        working-directory: infra/aws
        run: terraform apply -auto-approve
