name: 04 - AWS - Deploy to ECS

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-ecs.yml'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag for deployment'
        required: true
        default: 'latest'

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: "102503111808"
  AWS_ROLE_NAME: "rupaya-terraform-cicd"
  ECR_REPOSITORY: rupaya-backend
  ECS_CLUSTER: rupaya-ecs
  ECS_SERVICE: rupaya-backend

jobs:
  build-and-deploy:
    name: Build and Deploy to ECS
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/${{ env.AWS_ROLE_NAME }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Determine version tag
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION=${{ github.event.inputs.version }}
          else
            VERSION=v${{ github.run_number }}-${{ github.sha | cut -c1-7 }}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Deploying version: $VERSION"
      
      - name: Build and Push Docker image (linux/amd64 for ECS)
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.version.outputs.version }}
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Verify image in ECR
        run: |
          aws ecr describe-images \
            --repository-name ${{ env.ECR_REPOSITORY }} \
            --image-ids imageTag=${{ steps.version.outputs.version }} \
            --region ${{ env.AWS_REGION }} \
            --query 'imageDetails[0].[imageSizeInBytes,imagePushedAt]'
      
      - name: Get current task definition
        id: task-def
        run: |
          aws ecs describe-task-definition \
            --task-definition rupaya-backend \
            --region ${{ env.AWS_REGION }} \
            --query 'taskDefinition' \
            --output json > /tmp/task-def.json
          echo "task_def=$(cat /tmp/task-def.json)" >> $GITHUB_OUTPUT
      
      - name: Update task definition with new image
        id: new-task-def
        run: |
          cat /tmp/task-def.json | jq \
            --arg IMAGE "${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.version.outputs.version }}" \
            '.containerDefinitions[0].image = $IMAGE | 
             del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)' \
            > /tmp/new-task-def.json
          cat /tmp/new-task-def.json
      
      - name: Register new ECS task definition
        id: register-task
        run: |
          TASK_DEF_ARN=$(cat /tmp/new-task-def.json | aws ecs register-task-definition \
            --region ${{ env.AWS_REGION }} \
            --cli-input-json file:///dev/stdin \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)
          echo "task_def_arn=$TASK_DEF_ARN" >> $GITHUB_OUTPUT
          echo "Task Definition: $TASK_DEF_ARN"
      
      - name: Update ECS service
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_SERVICE }} \
            --task-definition ${{ steps.register-task.outputs.task_def_arn }} \
            --region ${{ env.AWS_REGION }} \
            --query 'service.[serviceName,status,taskDefinition]'
      
      - name: Wait for service to stabilize
        run: |
          echo "Waiting for ECS service to stabilize..."
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }} \
            --region ${{ env.AWS_REGION }}
          echo "✓ Service is stable"
      
      - name: Verify deployment
        run: |
          echo "Deployment Summary:"
          aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }} \
            --region ${{ env.AWS_REGION }} \
            --query 'services[0].[serviceName,status,runningCount,desiredCount,deployments[0].status]' \
            --output table
      
      - name: Health check
        run: |
          ALB_DNS=$(aws elbv2 describe-load-balancers \
            --query "LoadBalancers[?LoadBalancerName=='rupaya-alb'].DNSName" \
            --output text \
            --region ${{ env.AWS_REGION }})
          
          if [ -z "$ALB_DNS" ]; then
            echo "⚠ ALB DNS not found"
            exit 0
          fi
          
          echo "Testing health endpoint: http://$ALB_DNS/health"
          
          for i in {1..10}; do
            if curl -sf "http://$ALB_DNS/health" | grep -q "OK"; then
              echo "✓ Health check passed"
              exit 0
            fi
            echo "  Attempt $i/10 - retrying in 5 seconds..."
            sleep 5
          done
          
          echo "⚠ Health check timeout - service may still be stabilizing"
      
      - name: Deployment success notification
        if: success()
        run: |
          echo "✓ Deployment successful"
          echo "Version: ${{ steps.version.outputs.version }}"
          echo "Task Definition: ${{ steps.register-task.outputs.task_def_arn }}"
