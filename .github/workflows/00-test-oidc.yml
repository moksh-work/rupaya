name: 00 - Test OIDC Authentication

on:
  push:
    branches:
      - '**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test (all, development, staging, production)'
        required: false
        default: 'development'
        type: choice
        options:
          - all
          - development
          - staging
          - production
  schedule:
    - cron: '0 3 * * 0'  # Weekly health check

permissions:
  id-token: write
  contents: read

jobs:
  test-oidc:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'all' && fromJSON('["development", "staging", "production"]') || github.event_name == 'workflow_dispatch' && fromJSON(format('["{0}"]', github.event.inputs.environment)) || fromJSON('["development"]') }}
      fail-fast: false
    environment: ${{ matrix.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Role ARN
        id: role
        run: |
          set -euo pipefail
          case "${{ matrix.environment }}" in
            development)
              ROLE_ARN="${{ secrets.AWS_OIDC_ROLE_ARN_DEV }}"
              ;;
            staging)
              ROLE_ARN="${{ secrets.AWS_OIDC_ROLE_ARN_STAGING }}"
              ;;
            production)
              ROLE_ARN="${{ secrets.AWS_OIDC_ROLE_ARN_PROD }}"
              ;;
          esac

          if [ -z "${ROLE_ARN:-}" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "role_arn=" >> $GITHUB_OUTPUT
            echo "⚠ Missing OIDC role secret for ${{ matrix.environment }}. Skipping environment."
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "role_arn=$ROLE_ARN" >> $GITHUB_OUTPUT
          fi

      - name: Configure AWS Credentials (OIDC)
        if: steps.role.outputs.skip != 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ steps.role.outputs.role_arn }}
          aws-region: us-east-1

      - name: Verify OIDC Authentication
        if: steps.role.outputs.skip != 'true'
        run: |
          set -e
          echo "=== Testing ${{ matrix.environment }} Environment ==="
          echo "=== AWS Identity ==="
          IDENTITY=$(aws sts get-caller-identity)
          echo "$IDENTITY" | jq .
          
          ACCOUNT_ID=$(echo "$IDENTITY" | jq -r '.Account')
          ARN=$(echo "$IDENTITY" | jq -r '.Arn')
          
          echo ""
          echo "=== Verification ==="
          echo "✓ Account: $ACCOUNT_ID"
          echo "✓ Role: $ARN"
          
          # Verify correct role for environment
          if [[ "$ARN" == *"rupaya-github-oidc-${{ matrix.environment == 'development' && 'dev' || matrix.environment }}"* ]]; then
            echo "✓ Using correct ${{ matrix.environment }} OIDC role"
          else
            echo "✗ ERROR: Not using correct role for ${{ matrix.environment }}!"
            exit 1
          fi

      - name: Check ECR Repositories
        if: steps.role.outputs.skip != 'true'
        run: |
          echo "=== ECR Repositories ==="
          aws ecr describe-repositories \
            --region us-east-1 \
            --query 'repositories[*].repositoryName' \
            --output table || echo "⚠ No ECR repositories found (may still deploy successfully)"

      - name: Check ECS Clusters
        if: steps.role.outputs.skip != 'true'
        run: |
          echo "=== ECS Clusters ==="
          aws ecs list-clusters \
            --region us-east-1 \
            --query 'clusterArns[*]' \
            --output table || echo "⚠ No ECS clusters found yet"

      - name: Verify S3 Terraform State Access
        if: steps.role.outputs.skip != 'true'
        run: |
          echo "=== Terraform State S3 Bucket ==="
          if aws s3 ls s3://rupaya-terraform-state --region us-east-1 > /dev/null 2>&1; then
            echo "✓ Can access rupaya-terraform-state bucket"
            aws s3 ls s3://rupaya-terraform-state --region us-east-1 --recursive | head -5
          else
            echo "⚠ rupaya-terraform-state bucket not accessible (may not exist yet)"
          fi

      - name: Verify DynamoDB Terraform Lock
        if: steps.role.outputs.skip != 'true'
        run: |
          echo "=== Terraform Lock DynamoDB Table ==="
          if aws dynamodb describe-table \
            --table-name rupaya-terraform-lock \
            --region us-east-1 > /dev/null 2>&1; then
            echo "✓ Can access rupaya-terraform-lock table"
          else
            echo "⚠ Terraform lock table not found yet (will be created on first apply)"
          fi

      - name: Test RDS Access
        if: steps.role.outputs.skip != 'true'
        run: |
          echo "=== RDS Instances ==="
          aws rds describe-db-instances \
            --region us-east-1 \
            --query 'DBInstances[*].DBInstanceIdentifier' \
            --output table || echo "⚠ No RDS instances found yet"

      - name: Test Secrets Manager Access
        if: steps.role.outputs.skip != 'true'
        run: |
          echo "=== Secrets Manager (rupaya/*) ==="
          aws secretsmanager list-secrets \
            --region us-east-1 \
            --filters Key=name,Values=rupaya \
            --query 'SecretList[*].Name' \
            --output table || echo "⚠ No rupaya secrets found yet"

      - name: Summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "✅ OIDC Authentication Test Complete - ${{ matrix.environment }}"
          echo "=========================================="
          echo ""
          echo "Environment: ${{ matrix.environment }}"
          echo "Role ARN: ${{ steps.role.outputs.role_arn }}"
          if [ "${{ steps.role.outputs.skip }}" = "true" ]; then
            echo "Status: Skipped (missing secret)"
          else
            echo "Status: Completed"
          fi
          echo ""
          echo "Next steps:"
          echo "1. Verify all three role ARNs in GitHub secrets:"
          echo "   - AWS_OIDC_ROLE_ARN_DEV (development)"
          echo "   - AWS_OIDC_ROLE_ARN_STAGING (staging)"
          echo "   - AWS_OIDC_ROLE_ARN_PROD (production)"
          echo "2. Ensure development/staging/production environments exist"
          echo "3. Workflows 05-07 will use environment-specific roles"
          echo ""
