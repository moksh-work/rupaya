name: Test OIDC Authentication

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * 0'  # Weekly health check

jobs:
  test-oidc:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: us-east-1

      - name: Verify OIDC Authentication
        run: |
          set -e
          echo "=== AWS Identity ==="
          IDENTITY=$(aws sts get-caller-identity)
          echo "$IDENTITY" | jq .
          
          ACCOUNT_ID=$(echo "$IDENTITY" | jq -r '.Account')
          ARN=$(echo "$IDENTITY" | jq -r '.Arn')
          
          echo ""
          echo "=== Verification ==="
          echo "✓ Account: $ACCOUNT_ID"
          echo "✓ Role: $ARN"
          
          if [[ "$ARN" == *"rupaya-github-oidc"* ]]; then
            echo "✓ Using GitHub OIDC role (not hardcoded credentials)"
          else
            echo "✗ ERROR: Not using rupaya-github-oidc role!"
            exit 1
          fi

      - name: Check ECR Repositories
        run: |
          echo "=== ECR Repositories ==="
          aws ecr describe-repositories \
            --region us-east-1 \
            --query 'repositories[*].repositoryName' \
            --output table || echo "⚠ No ECR repositories found (may still deploy successfully)"

      - name: Check ECS Clusters
        run: |
          echo "=== ECS Clusters ==="
          aws ecs list-clusters \
            --region us-east-1 \
            --query 'clusterArns[*]' \
            --output table || echo "⚠ No ECS clusters found yet"

      - name: Verify S3 Terraform State Access
        run: |
          echo "=== Terraform State S3 Bucket ==="
          if aws s3 ls s3://rupaya-terraform-state --region us-east-1 > /dev/null 2>&1; then
            echo "✓ Can access rupaya-terraform-state bucket"
            aws s3 ls s3://rupaya-terraform-state --region us-east-1 --recursive | head -5
          else
            echo "⚠ rupaya-terraform-state bucket not accessible (may not exist yet)"
          fi

      - name: Verify DynamoDB Terraform Lock
        run: |
          echo "=== Terraform Lock DynamoDB Table ==="
          if aws dynamodb describe-table \
            --table-name rupaya-terraform-lock \
            --region us-east-1 > /dev/null 2>&1; then
            echo "✓ Can access rupaya-terraform-lock table"
          else
            echo "⚠ Terraform lock table not found yet (will be created on first apply)"
          fi

      - name: Test RDS Access
        run: |
          echo "=== RDS Instances ==="
          aws rds describe-db-instances \
            --region us-east-1 \
            --query 'DBInstances[*].DBInstanceIdentifier' \
            --output table || echo "⚠ No RDS instances found yet"

      - name: Test Secrets Manager Access
        run: |
          echo "=== Secrets Manager (rupaya/*) ==="
          aws secretsmanager list-secrets \
            --region us-east-1 \
            --filters Key=name,Values=rupaya \
            --query 'SecretList[*].Name' \
            --output table || echo "⚠ No rupaya secrets found yet"

      - name: Summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "✅ OIDC Authentication Test Complete"
          echo "=========================================="
          echo ""
          echo "Next steps:"
          echo "1. Verify role ARN in AWS_OIDC_ROLE_ARN secret"
          echo "2. Create development/staging/production environments"
          echo "3. Workflows 05-07 will now work without hardcoded credentials"
          echo ""
