name: 00 - Verify OIDC Role Setup

on:
  push:
    branches:
      - '**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to verify (development, staging, production)'
        required: false
        default: 'development'
        type: choice
        options:
          - development
          - staging
          - production

permissions:
  contents: read

jobs:
  verify-oidc-setup:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: ${{ github.event_name == 'workflow_dispatch' && fromJSON(format('["{0}"]', github.event.inputs.environment)) || fromJSON('["development"]') }}
      fail-fast: false
    steps:
      - name: Check GitHub Secret Exists
        id: check_secret
        run: |
          set -euo pipefail
          
          case "${{ matrix.environment }}" in
            development)
              SECRET_NAME="AWS_OIDC_ROLE_ARN_DEV"
              ROLE_ARN="${{ secrets.AWS_OIDC_ROLE_ARN_DEV }}"
              ;;
            staging)
              SECRET_NAME="AWS_OIDC_ROLE_ARN_STAGING"
              ROLE_ARN="${{ secrets.AWS_OIDC_ROLE_ARN_STAGING }}"
              ;;
            production)
              SECRET_NAME="AWS_OIDC_ROLE_ARN_PROD"
              ROLE_ARN="${{ secrets.AWS_OIDC_ROLE_ARN_PROD }}"
              ;;
          esac
          
          echo "secret_name=$SECRET_NAME" >> $GITHUB_OUTPUT
          
          if [ -z "${ROLE_ARN:-}" ]; then
            echo "✗ GitHub secret $SECRET_NAME is not configured"
            echo "exists=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "✓ GitHub secret $SECRET_NAME exists"
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "role_arn=$ROLE_ARN" >> $GITHUB_OUTPUT

      - name: Validate ARN Format
        if: steps.check_secret.outputs.exists == 'true'
        run: |
          set -euo pipefail
          ROLE_ARN="${{ steps.check_secret.outputs.role_arn }}"
          
          if [[ ! "$ROLE_ARN" =~ ^arn:aws:iam::[0-9]{12}:role/.+ ]]; then
            echo "✗ ${{ steps.check_secret.outputs.secret_name }} is not a valid IAM Role ARN"
            echo "  Current: $ROLE_ARN"
            echo "  Expected format: arn:aws:iam::<account-id>:role/<role-name>"
            exit 1
          fi
          
          echo "✓ ARN format is valid: $ROLE_ARN"

      - name: Summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "OIDC Setup Verification - ${{ matrix.environment }}"
          echo "=========================================="
          echo ""
          if [ "${{ steps.check_secret.outputs.exists }}" = "true" ]; then
            echo "✅ GitHub Secret: Configured"
            echo "✅ ARN Format: Valid"
            echo ""
            echo "OIDC role is ready for use in workflows"
          else
            echo "❌ GitHub Secret: Not configured"
            echo ""
            echo "Run ./scripts/bootstrap-oidc.sh to set up OIDC"
          fi
          echo ""
