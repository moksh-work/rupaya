name: 00 - Test OIDC Authentication

on:
  push:
    branches:
      - '**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test (all, development, staging, production)'
        required: false
        default: 'development'
        type: choice
        options:
          - all
          - development
          - staging
          - production

permissions:
  id-token: write
  contents: read

jobs:
  test-oidc:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'all' && fromJSON('["development", "staging", "production"]') || github.event_name == 'workflow_dispatch' && fromJSON(format('["{0}"]', github.event.inputs.environment)) || fromJSON('["development"]') }}
      fail-fast: false
    environment: ${{ matrix.environment }}
    steps:
      - name: Set Role ARN
        id: role
        run: |
          set -euo pipefail
          case "${{ matrix.environment }}" in
            development)
              ROLE_ARN="${{ secrets.AWS_OIDC_ROLE_ARN_DEV }}"
              ;;
            staging)
              ROLE_ARN="${{ secrets.AWS_OIDC_ROLE_ARN_STAGING }}"
              ;;
            production)
              ROLE_ARN="${{ secrets.AWS_OIDC_ROLE_ARN_PROD }}"
              ;;
          esac

          if [ -z "${ROLE_ARN:-}" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "role_arn=" >> $GITHUB_OUTPUT
            echo "⚠ Missing OIDC role secret for ${{ matrix.environment }}. Skipping environment."
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "role_arn=$ROLE_ARN" >> $GITHUB_OUTPUT
          fi

      - name: Validate Role ARN Format
        if: steps.role.outputs.skip != 'true'
        run: |
          set -euo pipefail
          ROLE_ARN="${{ steps.role.outputs.role_arn }}"
          if [[ ! "$ROLE_ARN" =~ ^arn:aws:iam::[0-9]{12}:role/.+ ]]; then
            echo "✗ Secret for ${{ matrix.environment }} must be a full IAM Role ARN."
            echo "  Expected: arn:aws:iam::<account-id>:role/<role-name>"
            exit 1
          fi
          echo "✓ Role ARN format is valid"

      - name: Configure AWS Credentials (OIDC)
        if: steps.role.outputs.skip != 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ steps.role.outputs.role_arn }}
          aws-region: us-east-1

      - name: Verify OIDC Authentication
        if: steps.role.outputs.skip != 'true'
        run: |
          set -e
          echo "=== Testing ${{ matrix.environment }} Environment ==="
          echo "=== AWS Identity ==="
          IDENTITY=$(aws sts get-caller-identity)
          echo "$IDENTITY" | jq .
          
          ACCOUNT_ID=$(echo "$IDENTITY" | jq -r '.Account')
          ARN=$(echo "$IDENTITY" | jq -r '.Arn')
          
          echo ""
          echo "=== Verification ==="
          echo "✓ Account: $ACCOUNT_ID"
          echo "✓ Role: $ARN"
          
          # Verify correct role for environment
          if [[ "$ARN" == *"rupaya-github-oidc-${{ matrix.environment == 'development' && 'dev' || matrix.environment }}"* ]]; then
            echo "✓ Using correct ${{ matrix.environment }} OIDC role"
          else
            echo "✗ ERROR: Not using correct role for ${{ matrix.environment }}!"
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "OIDC Role Verification - ${{ matrix.environment }}"
          echo "=========================================="
          echo ""
          echo "Environment: ${{ matrix.environment }}"
          echo "Role ARN configured: ${{ steps.role.outputs.skip != 'true' }}"
          if [ "${{ steps.role.outputs.skip }}" = "true" ]; then
            echo "Status: Skipped (missing secret)"
          else
            echo "Status: ${{ job.status }}"
          fi
